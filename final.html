<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H1E è¬è§£ã - ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* ãƒšãƒ¼ã‚¸å†…ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ï¼ˆã‚‚ã—å¿…è¦ã§ã‚ã‚Œã°ï¼‰ */
      .container {
        text-align: center;
        max-width: 600px;
        margin: 30px auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #result-area {
        background-color: #e8f5e9; /* è–„ã„ç·‘è‰² */
      }
      .hidden {
        display: none;
      }
      #end-game-button {
        background-color: #00796b;
        color: white;
        padding: 10px 20px;
        font-size: 1.2em;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header><p id="user-info">[ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ]ã•ã‚“ã®ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢</p></header>

    <main>
      <h1>ğŸ‰ è¬è§£ãã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ‰</h1>
      <p>
        ã™ã¹ã¦ã®è¬ã‚’è§£ãçµ‚ãˆã¾ã—ãŸã€‚æœ€å¾Œã«ã€Œçµæœè¡¨ç¤ºã¨ãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€æ™¯å“äº¤æ›ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚
      </p>

      <div class="container">
        <button id="end-game-button">çµæœè¡¨ç¤ºã¨ãƒªã‚»ãƒƒãƒˆ</button>

        <p id="status-message" style="margin-top: 20px; font-weight: bold"></p>

        <div
          id="result-area"
          class="hidden"
          style="
            margin-top: 30px;
            border: 2px solid #00796b;
            padding: 15px;
            border-radius: 8px;
          "
        >
          <h2>è¡¨ç¤ºå®Œäº†ï¼</h2>
          <p>æ™¯å“äº¤æ›ç”¨ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç”Ÿæˆï¼‰ï¼š</p>
          <div
            style="
              font-size: 1.5em;
              font-weight: bold;
              color: #d32f2f;
              margin: 10px 0;
            "
          >
            <span id="display-code">CODE-TEST</span>
          </div>
          <p>
            ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚¿ãƒƒãƒ•ã«æç¤ºã—ã¦ãã ã•ã„ã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
          </p>
          <button
            onclick="window.location.href='index.html';"
            style="margin-top: 15px"
          >
            æœ€åˆã«æˆ»ã‚‹
          </button>
        </div>
      </div>
    </main>
  </body>
  <script>
    // æ™¯å“äº¤æ›ã‚³ãƒ¼ãƒ‰ã®æ§‹æˆ: [ã‚¯ãƒªã‚¢è­˜åˆ¥å­2æ¡] + [æ—¥è­˜åˆ¥å­1æ¡] + [æ™‚åˆ»4æ¡] + [å­¦å¹´è­˜åˆ¥å­1æ¡] + [ãƒ©ãƒ³ãƒ€ãƒ 2æ¡] = 10æ¡

    // å…¨ã¦ã®è¬ãŒã‚¯ãƒªã‚¢æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™å›ºå®šè­˜åˆ¥å­
    // æœªã‚¯ãƒªã‚¢ã®å ´åˆã¯ '00' ãŒè‡ªå‹•ã§è¨­å®šã•ã‚Œã¾ã™ã€‚
    const CLEARED_CODE = "99";
    const NOT_CLEARED_CODE = "00";

    const statusElements = {
      message: document.getElementById("status-message"),
      displayCode: document.getElementById("display-code"),
      resultArea: document.getElementById("result-area"),
      endButton: document.getElementById("end-game-button"),
    };
    let currentNickname = "";
    let finalPrizeCode = ""; // æœ€çµ‚çš„ãª10æ¡ã‚³ãƒ¼ãƒ‰ã‚’æ ¼ç´
    let isAllCleared = false; // ã‚¯ãƒªã‚¢çŠ¶æ…‹ã‚’è¿½è·¡ã™ã‚‹ãƒ•ãƒ©ã‚°

    /**
     * 00ã‹ã‚‰99ã¾ã§ã®ãƒ©ãƒ³ãƒ€ãƒ ãª2æ¡ã®æ•°å­—ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     */
    function generateRandom2DigitCode() {
      const randomNum = Math.floor(Math.random() * 100);
      return String(randomNum).padStart(2, "0");
    }

    window.onload = function () {
      currentNickname = sessionStorage.getItem("currentNickname");
      // URLéå¹²æ¸‰ã®sessionStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å®‰å…¨ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š)
      const dayIdentifier = sessionStorage.getItem("dayIdentifier") || "0";
      const timeCode = sessionStorage.getItem("timeCode") || "0000";
      const gradeIdentifier = sessionStorage.getItem("gradeIdentifier") || "0";

      // å¿…é ˆã®ã‚¯ãƒªã‚¢åˆ¤å®š
      const achievements = localStorage.getItem("h1e_achievements")
        ? JSON.parse(localStorage.getItem("h1e_achievements"))
        : [];
      const allQuizzes = ["è¬1", "è¬2", "è¬3", "è¬5"];
      isAllCleared = allQuizzes.every((id) => achievements.includes(id));

      let clearIdentifier = isAllCleared ? CLEARED_CODE : NOT_CLEARED_CODE; // ğŸš¨ ã‚¯ãƒªã‚¢çŠ¶æ…‹ã«ã‚ˆã£ã¦è­˜åˆ¥å­ã‚’è¨­å®š ğŸš¨

      // å¿…é ˆãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
      if (!currentNickname) {
        console.error("å¿…é ˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        alert("ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç™»éŒ²ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚");
        window.location.href = "index.html";
        return;
      }

      document.getElementById(
        "user-info"
      ).textContent = `${currentNickname}ã•ã‚“ã®ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢`;

      // 1. ãƒ©ãƒ³ãƒ€ãƒ ãª2æ¡ã®äºˆå‚™ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      const randomReserveCode = generateRandom2DigitCode();

      // 2. æœ€çµ‚ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      // æ§‹æˆ: [ã‚¯ãƒªã‚¢2æ¡] + [æ—¥1æ¡] + [æ™‚åˆ»4æ¡] + [å­¦å¹´1æ¡] + [ãƒ©ãƒ³ãƒ€ãƒ 2æ¡]
      finalPrizeCode =
        clearIdentifier + // 2æ¡ (99:ã‚¯ãƒªã‚¢æ¸ˆã¿, 00:æœªã‚¯ãƒªã‚¢)
        dayIdentifier + // 1æ¡ (ã‚¤ãƒ™ãƒ³ãƒˆæ—¥)
        timeCode + // 4æ¡ (HHMM)
        gradeIdentifier + // 1æ¡ (å­¦å¹´)
        randomReserveCode; // 2æ¡ (ãƒ©ãƒ³ãƒ€ãƒ )

      console.log(`[ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ] å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸæ™¯å“ã‚³ãƒ¼ãƒ‰ (${finalPrizeCode})`);

      // æœªã‚¯ãƒªã‚¢ã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è­¦å‘Šè‰²ã«å¤‰æ›´
      if (!isAllCleared) {
        statusElements.message.style.color = "orange";
        statusElements.message.innerHTML = `**ã€è­¦å‘Šã€‘å…¨ã¦ã®è¬ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚**ç„¡åŠ¹ãªæ™¯å“äº¤æ›ã‚³ãƒ¼ãƒ‰ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚`;
      }

      statusElements.endButton.addEventListener("click", showResultAndReset);
    };

    /**
     * çµæœã‚’è¡¨ç¤ºã—ã€ãƒ­ãƒ¼ã‚«ãƒ«/ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°ã€‚
     * å¤–éƒ¨ã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯è¡Œã„ã¾ã›ã‚“ã€‚
     */
    function showResultAndReset() {
      // ãƒœã‚¿ãƒ³ã®å¤šé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
      statusElements.endButton.disabled = true;
      statusElements.message.style.color = "gray";
      statusElements.message.textContent = "çµæœã‚’é›†è¨ˆä¸­...";

      // 1. çµæœè¡¨ç¤º
      statusElements.displayCode.textContent = finalPrizeCode;

      statusElements.resultArea.classList.remove("hidden");
      // ã‚¯ãƒªã‚¢ã—ã¦ã„ã‚‹å ´åˆã®ã¿ç·‘è‰²ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (isAllCleared) {
        statusElements.message.style.color = "green";
        statusElements.message.innerHTML = `é›†è¨ˆå®Œäº†ï¼æ™¯å“äº¤æ›ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚`;
      } else {
        // æœªã‚¯ãƒªã‚¢ã®å ´åˆã¯è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†è¡¨ç¤º
        statusElements.message.style.color = "orange";
        statusElements.message.innerHTML = `**ã€è­¦å‘Šã€‘å…¨ã¦ã®è¬ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚**ç„¡åŠ¹ãªæ™¯å“äº¤æ›ã‚³ãƒ¼ãƒ‰ãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸã€‚`;
      }

      // 2. ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
      localStorage.clear();
      sessionStorage.clear();

      console.log("[ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ] å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
    }
  </script>
</html>

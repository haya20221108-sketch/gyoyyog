<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H1E 謎解き - ゲームクリア</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* ページ内のスタイルを調整（もし必要であれば） */
      .container {
        text-align: center;
        max-width: 600px;
        margin: 30px auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #result-area {
        background-color: #e8f5e9; /* 薄い緑色 */
      }
      .hidden {
        display: none;
      }
      #end-game-button {
        background-color: #00796b;
        color: white;
        padding: 10px 20px;
        font-size: 1.2em;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header><p id="user-info">[ニックネーム]さんのゲームクリア</p></header>

    <main>
      <h1>🎉 謎解きクリアおめでとうございます！ 🎉</h1>
      <p>
        すべての謎を解き終えました。最後に「結果表示とリセット」ボタンを押して、景品交換コードを取得し、ゲームデータをリセットしてください。
      </p>

      <div class="container">
        <button id="end-game-button">結果表示とリセット</button>

        <p id="status-message" style="margin-top: 20px; font-weight: bold"></p>

        <div
          id="result-area"
          class="hidden"
          style="
            margin-top: 30px;
            border: 2px solid #00796b;
            padding: 15px;
            border-radius: 8px;
          "
        >
          <h2>表示完了！</h2>
          <p>景品交換用コード（ローカル生成）：</p>
          <div
            style="
              font-size: 1.5em;
              font-weight: bold;
              color: #d32f2f;
              margin: 10px 0;
            "
          >
            <span id="display-code">CODE-TEST</span>
          </div>
          <p>
            このコードをスタッフに提示してください。ありがとうございました！
          </p>
          <button
            onclick="window.location.href='index.html';"
            style="margin-top: 15px"
          >
            最初に戻る
          </button>
        </div>
      </div>
    </main>
  </body>
  <script>
    // 景品交換コードの構成: [クリア識別子2桁] + [日識別子1桁] + [時刻4桁] + [学年識別子1桁] + [ランダム2桁] = 10桁

    // 全ての謎がクリア済みであることを示す固定識別子
    // 未クリアの場合は '00' が自動で設定されます。
    const CLEARED_CODE = "99";
    const NOT_CLEARED_CODE = "00";

    const statusElements = {
      message: document.getElementById("status-message"),
      displayCode: document.getElementById("display-code"),
      resultArea: document.getElementById("result-area"),
      endButton: document.getElementById("end-game-button"),
    };
    let currentNickname = "";
    let finalPrizeCode = ""; // 最終的な10桁コードを格納
    let isAllCleared = false; // クリア状態を追跡するフラグ

    /**
     * 00から99までのランダムな2桁の数字を生成します。
     */
    function generateRandom2DigitCode() {
      const randomNum = Math.floor(Math.random() * 100);
      return String(randomNum).padStart(2, "0");
    }

    window.onload = function () {
      currentNickname = sessionStorage.getItem("currentNickname");
      // URL非干渉のsessionStorageからデータを取得 (データがない場合は安全なデフォルト値を設定)
      const dayIdentifier = sessionStorage.getItem("dayIdentifier") || "0";
      const timeCode = sessionStorage.getItem("timeCode") || "0000";
      const gradeIdentifier = sessionStorage.getItem("gradeIdentifier") || "0";

      // 必須のクリア判定
      const achievements = localStorage.getItem("h1e_achievements")
        ? JSON.parse(localStorage.getItem("h1e_achievements"))
        : [];
      const allQuizzes = ["謎1", "謎2", "謎3", "謎5"];
      isAllCleared = allQuizzes.every((id) => achievements.includes(id));

      let clearIdentifier = isAllCleared ? CLEARED_CODE : NOT_CLEARED_CODE; // 🚨 クリア状態によって識別子を設定 🚨

      // 必須データのチェック
      if (!currentNickname) {
        console.error("必須のセッションデータが見つかりません。");
        alert("エラー: ユーザー情報が見つかりません。登録ページに戻ります。");
        window.location.href = "index.html";
        return;
      }

      document.getElementById(
        "user-info"
      ).textContent = `${currentNickname}さんのゲームクリア`;

      // 1. ランダムな2桁の予備コードを生成
      const randomReserveCode = generateRandom2DigitCode();

      // 2. 最終コードを生成
      // 構成: [クリア2桁] + [日1桁] + [時刻4桁] + [学年1桁] + [ランダム2桁]
      finalPrizeCode =
        clearIdentifier + // 2桁 (99:クリア済み, 00:未クリア)
        dayIdentifier + // 1桁 (イベント日)
        timeCode + // 4桁 (HHMM)
        gradeIdentifier + // 1桁 (学年)
        randomReserveCode; // 2桁 (ランダム)

      console.log(`[コード生成] 割り当てられた景品コード (${finalPrizeCode})`);

      // 未クリアの場合はメッセージを警告色に変更
      if (!isAllCleared) {
        statusElements.message.style.color = "orange";
        statusElements.message.innerHTML = `**【警告】全ての謎がクリアされていません。**無効な景品交換コードが発行されます。`;
      }

      statusElements.endButton.addEventListener("click", showResultAndReset);
    };

    /**
     * 結果を表示し、ローカル/セッションストレージを全てクリアする関数。
     * 外部へのデータ送信は行いません。
     */
    function showResultAndReset() {
      // ボタンの多重クリック防止
      statusElements.endButton.disabled = true;
      statusElements.message.style.color = "gray";
      statusElements.message.textContent = "結果を集計中...";

      // 1. 結果表示
      statusElements.displayCode.textContent = finalPrizeCode;

      statusElements.resultArea.classList.remove("hidden");
      // クリアしている場合のみ緑色のメッセージ
      if (isAllCleared) {
        statusElements.message.style.color = "green";
        statusElements.message.innerHTML = `集計完了！景品交換コードが表示されました。`;
      } else {
        // 未クリアの場合は警告メッセージを再表示
        statusElements.message.style.color = "orange";
        statusElements.message.innerHTML = `**【警告】全ての謎がクリアされていません。**無効な景品交換コードが発行されました。`;
      }

      // 2. データの完全リセット
      localStorage.clear();
      sessionStorage.clear();

      console.log("[データリセット] 全てのデータをクリアしました。");
    }
  </script>
</html>
